# Mario Kart World - Race Result Analyzer

## 概要 (Overview)

このアプリケーションは、PCでプレイしている「マリオカートワールド」のゲームプレイ映像をリアルタイムで監視し、レース結果を自動で記録・分析するためのツールです。キャプチャーデバイスや特定のウィンドウ画面を監視し、コース決定画面やリザルト画面が表示されると自動で情報を抽出し、CSVファイルに保存します。

## 主な機能 (Key Features)

  * **リアルタイム監視**: 映像デバイスまたはウィンドウを指定して、ゲーム画面をバックグラウンドで監視します。
  * **自動画面検出**: 「コース決定画面」と「リザルト画面」を自動で認識します。
  * **高精度なデータ自動抽出**:
      * **Google Gemini API** を利用し、複雑な背景からでも**コース名**を高い精度で認識します。
      * **Tesseract-OCR** を利用し、レースの**順位**、**レート**、**レート変動値**などの数値を画像から読み取ります。
  * **レースパターン識別**: 1つのコースで完結する**単独レース**と、2つのコースを連続で走る**2連続レース**のパターンを自動で判別し、適切に記録します。
  * **CSVロギング**: 抽出した全データをCSVファイルに時系列で記録します。
  * **統計情報表示**: アプリケーションのGUIに、合計レース数や平均レートなどの統計情報を表示します。
  * **手動入力支援**: レース記録の手動追加・編集時には、実際に存在するルートの組み合わせしか選択できないように候補が絞り込まれ、入力ミスを防ぎます。
  * **デバッグ機能**: 監視中の状況や、画像解析の各ステップを画像として保存し、問題解決をサポートします。

## セットアップ (Setup)

### 1\. Google Gemini API キーの取得

このアプリケーションは、コース名を認識するために **Google Gemini API** を使用します。

  * [Google AI Studio](https://aistudio.google.com/app/apikey) にアクセスし、ご自身のGoogleアカウントでAPIキーを無料で取得してください。
  * 取得したAPIキーは、アプリケーションの初回起動時に表示されるダイアログに入力します。

### 2\. Tesseract-OCR のインストール

レースの順位やレートといった**数値**を認識するために **Tesseract-OCR** を使用します。

  * 公式インストーラー（例: `tesseract-ocr-w64-setup-v5.X.X....exe`）をダウンロードし、インストールしてください。
  * **重要**: インストール時に、「Additional language data」の項目で **"Japanese"** にチェックを入れてください。
  * インストール後、`src/app.py`内の`TESSERACT_PATH`変数が、ご自身のTesseractのインストール先（通常は `C:\Program Files\Tesseract-OCR\tesseract.exe`）を指していることを確認してください。

### 3\. Pythonライブラリのインストール

プロジェクトのルートディレクトリで、以下のコマンドを実行して必要なライブラリをインストールします。

```bash
pip install -r requirements.txt
```

#### `requirements.txt` の内容

```
opencv-python
numpy
pygrabber
pygetwindow
pytesseract
Pillow
google-generativeai
win32gui
win32ui
win32con
```

## 使い方 (Usage)

1.  `src` フォルダにある `app.py` を実行します。
    ```bash
    python src/app.py
    ```
2.  **初回起動時**、Google Gemini APIキーの入力を求めるダイアログが表示されます。取得したキーを入力してください。
      * 入力されたキーは、Gitの追跡対象外である `src/private_config.ini` ファイルに安全に保存されます。
3.  「監視コントロール」ウィンドウが表示されたら、「監視ソース」から「映像デバイス」または「ウィンドウ」を選択し、ドロップダウンリストから対象を選択します。
4.  「監視開始」ボタンを押すと、自動で画面の監視と解析が始まります。
5.  監視を停止したい場合は、メインウィンドウの「監視停止」ボタンを押します。

## フォルダ構成 (Folder Structure)

```
mkworld-tracker/
|-- data/                  # プログラムが生成するデータ
|   |-- temp/              #  ├ 一時的なスクリーンショットや切り抜き画像
|   |-- output/            #  ├ 最終的なCSVデータ (race_data.csv)
|   |-- debug/             #  └ デバッグモードで保存される画像
|-- src/                   # ソースコード
|   |-- app.py             #  ├ メインアプリ (GUI, 監視ループ)
|   |-- analysis.py        #  ├ 解析ロジック
|   |-- imaging.py         #  ├ 画像処理 (切り抜き、デバッグ描画)
|   |-- ocr.py             #  ├ OCR・Gemini API関連
|   |-- config.py          #  ├ 座標やルート定義などの設定ファイル
|   |-- private_config.ini #  └ (自動生成) APIキーを保存するプライベートな設定ファイル
|-- .gitignore
|-- requirements.txt
|-- README.md
```

## 設定の調整 (Configuration)

`src/config.py` ファイルを編集することで、アプリケーションの動作をカスタマイズできます。

  * **座標値**: キャプチャ環境（解像度など）によって画像認識がうまくいかない場合、ファイル内の各`x1, y1, x2, y2`の値を微調整してください。デバッグ機能で出力される画像が調整の助けになります。
  * **ルート定義**: 手動入力時に使用される2連続レースの有効なルートは `VALID_ROUTES` リストで定義されています。必要に応じて編集が可能です。